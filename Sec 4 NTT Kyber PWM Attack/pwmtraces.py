import numpy as np
import random
import csv

# -------------------- OMEGA --------------------
ome1 = [
    3052, 443, 1093, 1075, 513, 1463, 1927, 546, 606, 2468, 2392, 2179,
    3132, 2274, 1077, 2107, 1149, 2537, 646, 1610, 2487, 2284, 1477,
    2939, 1824, 1133, 278, 2043, 1945, 615, 1297, 1233, 134, 1985,
    1298, 2833, 1194, 446, 1195, 1154, 476, 741, 934, 3008, 2559,
    270, 813, 2490, 3045, 1656, 1373, 2989, 550, 2185, 846, 2026,
    1331, 960, 24, 1781, 1078, 2951, 1525, 3172
]

omega = ome1 + ome1 + ome1 + ome1 + ome1

# -------------------- RAPL --------------------
RAPL_PKG = "/sys/devices/virtual/powercap/intel-rapl/intel-rapl:0/intel-rapl:0:0/energy_uj"

def rapl_measure():
    with open(RAPL_PKG, "r") as f:
        return int(f.read().strip())

# -------------------- MONTGOMERY --------------------
def montgomery(a, b, r, r_bar, n_bar, power):
    n = 3329
    t = (a * b) % n
    m = (t * n_bar) % r
    u = (t + m * n) >> power
    return u - n if u > n else u

# -------------------- MULTIPLICATION --------------------
def multiplication(a0, a1, b0, b1, omega):
    s0 = (a0 + a1) % 3329
    s1 = (b0 + b1) % 3329

    m0 = montgomery(a0, b0, 4096, 2704, 3327, 12)
    m1 = montgomery(a1, b1, 4096, 2704, 3327, 12)

    s2 = (m0 + m1) % 3329
    m2 = montgomery(s0, s1, 4096, 2704, 3327, 12)
    m3 = montgomery(m1, omega, 4096, 2704, 3327, 12)

    out1 = (m0 + m3) % 3329
    out2w = m2 - s2
    out2 = out2w if out2w > 0 else 3329 + out2w

    return out1, out2

# -------------------- RAM --------------------
ram1 = [124, 2917, 45, 1802, 102, 11, 2045, 98, 1567, 2401, 876, 19, 3104, 221, 1678, 290, 1455, 327, 2019, 1184, 30, 77, 199, 2650, 1842, 909, 2711, 54, 316, 1489, 2304, 997, 611, 1742, 2891, 1864, 1250, 2067, 418, 3129, 81, 1964, 258, 1433, 3250, 709, 187, 2341, 1602, 94, 2798, 1207, 455, 3191, 3190, 880, 1701, 2664, 37, 142, 2999, 1148, 2033, 621, 1875, 301, 2499, 92, 1356, 2870, 540, 1991, 110, 3227, 1684, 733, 255, 2149, 149, 3042, 903, 1761, 60, 2678, 1302, 414, 3210, 2751, 2417, 1550, 704, 28, 2934, 169, 1980, 2566, 1001, 1829, 312, 1447, 2290, 83, 3205, 611, 174, 2671, 1390, 448, 3007, 911, 2054, 121, 1866, 2450, 63, 1588, 2723, 701, 318, 2137, 740, 2902, 91, 333, 1998, 1154, 3061, 471, 832, 1671, 2844, 52, 190, 2309, 1431, 3277, 612, 1759, 104, 790, 198, 3169, 923, 1417, 2442, 71, 158, 2948, 1199, 2090, 503, 3216, 871, 1768, 289, 1350, 2611, 94, 3099, 612, 1834, 418, 2749, 120, 1507, 2976, 682, 213, 3291, 982, 1643, 57, 245, 2012, 1425, 2868, 718, 1879, 336, 3108, 146, 115, 84, 2277, 2910, 491, 178, 3199, 913, 1440, 2675, 62, 1852, 3001, 733, 221, 2134, 1599, 95, 3256, 1187, 176, 2897, 1408, 472, 2071, 320, 2539, 1679, 489, 3121, 911, 144, 2762, 1203, 1986, 401, 3244, 731, 185, 2145, 779, 2994, 67, 1002, 2418, 1466, 329, 1760, 2875, 512, 219, 138, 389, 642, 777, 904, 1111, 1288, 1399, 1512, 1627, 1739, 1855, 1966, 925, 2193, 2317, 2438, 2547, 2661, 2784, 2899, 3015, 3146, 3268]

# -------------------- PARAMETERS --------------------
num_traces = 1000000
num_mults = 100
IDX_LIST =list(range(256))
# -------------------- TRACE COLLECTION --------------------
for idx in IDX_LIST:
    print(ram1[idx]) 	
    filename = f"traces/ntt_traces_with_b{idx}_as_random_a{idx}_new.csv"
    print(f"Collecting traces for index {idx} â†’ {filename}")

    with open(filename, "w", newline="") as f:
        writer = csv.writer(f)
        writer.writerow([f"u{idx}", "energy"])

        for i in range(num_traces):
            if i % 10_000 == 0:
                print(f"idx {idx} | Trace {i}")

            b = random.randint(1, 3328)

            e0 = rapl_measure()
            for _ in range(num_mults):
                if idx % 2 == 0:
                    # even index
                    multiplication(
                        ram1[idx], 0,
                        b, 0,
                        omega[idx]
                    )
                else:
                    # odd index
                    multiplication(
                        0, ram1[idx],
                        0, b,
                        omega[idx]
                    )
            e1 = rapl_measure()

            energy = e1 - e0
            writer.writerow([b, energy])
